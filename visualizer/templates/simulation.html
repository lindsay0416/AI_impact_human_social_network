<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM-AIDSim</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.1/cytoscape.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: #f2f2f2;
            padding: 10px 20px;
            text-align: center;
            color: #333;
        }
        #container {
            display: flex;
            flex: 1;
            padding: 20px;
        }
        #form-container {
            width: 33.33%;
            padding: 20px;
            box-sizing: border-box;
        }
        #content {
            width: 66.66%;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f8f9fa;
            height: 100%; /* Adjust height if necessary */
        }
        #output-container {
            padding: 20px;
            box-sizing: border-box;
            height: 100%; /* Adjust height if necessary */
        }
        form, #content {
            display: block;
            height: auto;
        }
        #buttons {
            margin-bottom: 20px;
        }

        #buttons button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #buttons button:hover {
            background-color: #45a049;
        }

        /* Tooltip styles */
        .cy-tooltip {
            position: absolute;
            max-width: 200px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
            display: none;
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LLM-AIDSim: An LLM-enhanced Agent-based Influence Diffusion Simulation Tool</h1>
    </div>
    <div id="container">
        <div id="form-container">
            <h2>Simulation Parameters</h2>
            <form action="/submit" method="post">
                <label for="round">Round:</label>
                <input type="number" id="round" name="round" value="{{ data.get('round', '1') }}"><br>

                <label for="timestep">Time Step:</label>
                <input type="number" id="timestep" name="timestep" value="{{ data.get('timestep', '1') }}"><br>

                <label for="influence_prob">Influence Probability:</label>
                <input type="text" id="influence_prob" name="influence_prob" value="{{ data.get('influence_prob', '0.3') }}"><br>

                <label for="is_directed">Is Directed:</label>
                <input type="checkbox" id="is_directed" name="is_directed" value="true" {% if data.get("is_directed") %}checked{% endif %}><br>

                <label for="is_external_dataset">Is External Dataset:</label>
                <input type="checkbox" id="is_external_dataset" name="is_external_dataset" value="true" {% if data.get("is_external_dataset") %}checked{% endif %}><br>

                <label for="node_size">Node Size:</label>
                <input type="number" id="node_size" name="node_size" value="{{ data.get('node_size', '100') }}"><br>

                <label for="random_edges">Random Edges:</label>
                <input type="number" id="random_edges" name="random_edges" value="{{ data.get('random_edges', '3') }}"><br>

                <label for="connect_prob">Connection Probability:</label>
                <input type="text" id="connect_prob" name="connect_prob" value="{{ data.get('connect_prob', '0.6') }}"><br>

                <label for="evolution_prob">Evolution Probability:</label>
                <input type="text" id="evolution_prob" name="evolution_prob" value="{{ data.get('evolution_prob', '0.3') }}"><br>

                <label for="generate_user_profile">Generate User Profile:</label>
                <input type="checkbox" id="generate_user_profile" name="generate_user_profile" value="true" {% if data.get("generate_user_profile") %}checked{% endif %}><br>
                <label for="user_profile_prompt" style="display: none;">User Profile Prompt:</label>
                <textarea id="user_profile_prompt" name="user_profile_prompt" rows="10" cols="48"  style="display: none;">List per user profiles each line.List per user profiles each line. Each profile follows a text format like this example: "1: {Name: Emily; Location: Auckland, New Zealand; Age: 32; Gender: Female; Education: Bachelor; Occupation: Artist; Description: Emily loves expressing herself through paintings. She finds inspiration in nature and often exhibits her artwork in local galleries.}"</textarea><br>

                <label for="location">Location:</label>
                <select id="location" name="location">
                    <option value="Hobart, Australia" {% if data.get('location') == "Hobart, Australia" %}selected{% endif %}>Hobart, Australia</option>
                    <option value="Auckland, New Zealand" {% if data.get('location') == "Auckland, New Zealand" %}selected{% endif %}>Auckland, New Zealand</option>
                    <option value="Sydney, Australia" {% if data.get('location') == "Sydney, Australia" %}selected{% endif %}>Sydney, Australia</option>
                    <option value="" {% if data.get('location') == "" %}selected{% endif %}>Worldwide</option>
                </select><br>

                <label for="broadcasting_prob">Broadcasting Probability:</label>
                <input type="text" id="broadcasting_prob" name="broadcasting_prob" value="{{ data.get('broadcasting_prob', '0.3') }}"><br>

                <label for="initial_message">Initial Message:</label>
                <textarea id="initial_message" name="initial_message" rows="10" cols="48">Hello from LLM-AIDSim!</textarea><br>

                <button type="submit">Submit Parameter Settings</button>
            </form>
        </div>
        <div id="content">
            <h2>Canvas</h2>
            <div id="buttons">
                <button type="button" id="start-btn">Start</button>
                <button type="button" id="pause-btn">Pause</button>
                <button type="button" id="reset-btn">Reset</button>
                <!-- <button type="button" onclick="loadGraph()">Graph Information</button> -->
            </div>
            <div id="cy" style="width: 800px; height: 600px;"></div>
        </div>
    </div>
    
    <div id="output-container">
        <h2>Simulation Report</h2>
        <pre id="output"></pre>
        <button type="button" onclick="fetchSimulationResult()">Fetch Simulation Report</button>
    </div>

    <script>
        let cy;
        let animationInterval;
        let currentRound = 0;
        let currentStep = 0;
        let simulationData;
        let isPaused = false;

        function loadSimulationData() {
            return fetch('/simulation-result')
                .then(response => response.json())
                .then(data => {
                    simulationData = data.simulation;
                });
        }

        // Function to get node data by ID from the simulation data
        function getNodeDataById(nodeId) {
            user_data = simulationData[currentRound].result[currentStep].user_data
            for (let user of user_data) {
                if (user.id.toString() === nodeId) {
                    return user;
                }
            }
            return null;
        }


        function colorMapping(status) {
            switch (status) {
                case 0: return '#ff0000'; // Red
                case 1: return '#00ff00'; // Green
                default: return '#cccccc'; // Grey
            }
        }

        function updateNodeColors(stepData) {
            stepData.user_data.forEach(user => {
                cy.getElementById(user.id.toString()).style('background-color', colorMapping(user.status));
            });
        }

        function parseResponse(text) {
            const jsonRegex = /{[^}]*"response"[^}]*"opinion"[^}]*"phrases"[^}]*}/;
            const match = text.match(jsonRegex);

            if (match) {
                const jsonString = match[0];

                try {
                    const jsonData = JSON.parse(jsonString);
                    return jsonData;
                } catch (e) {
                    console.error("Failed to parse JSON:", e);
                    return null;
                }
            } else {
                console.error("JSON not found in the text.");
                return null;
            }
        }

        function updateTooltip(nodeId) {
            const nodeData = getNodeDataById(nodeId);
            if (nodeData && nodeData.posts && nodeData.posts.length > 0) {
                const lastPost = nodeData.posts[nodeData.posts.length - 1];
                const lastPostData = parseResponse(lastPost);
                return `
                    <strong>Last Post:</strong><br>
                    ${lastPostData.response}<br>
                    Opinion: ${lastPostData.opinion}<br>
                    Phrases: ${lastPostData.phrases}
                `;
            } else {
                return "No posts available";
            }
        }

        function startAnimation() {
            if (!isPaused) {
                currentRound = 0;
                currentStep = 0;
            }

            isPaused = false;

            animationInterval = setInterval(() => {
                if (currentRound < simulationData.length) {
                    const roundData = simulationData[currentRound].result;

                    if (currentStep < roundData.length) {
                        currentSimulationData = roundData[currentStep]
                        updateNodeColors(roundData[currentStep]);
                        currentStep++;
                    } else {
                        // Move to the next round
                        currentRound++;
                        currentStep = 0;

                        if (currentRound < simulationData.length) {
                            // Initialize the first step of the next round
                            updateNodeColors(simulationData[currentRound].result[currentStep]);
                        } else {
                            clearInterval(animationInterval); // End of all rounds
                        }
                    }
                } else {
                    clearInterval(animationInterval); // End of all rounds
                }
            }, 3000);
        }


        function pauseAnimation() {
            clearInterval(animationInterval);
            isPaused = true;
        }

        function resetAnimation() {
            clearInterval(animationInterval);
            currentRound = 0;
            currentStep = 0;
            isPaused = true;
            cy.nodes().style('background-color', '#cccccc'); // Reset all node colors to grey
        }

        document.getElementById('start-btn').addEventListener('click', startAnimation);
        document.getElementById('pause-btn').addEventListener('click', pauseAnimation);
        document.getElementById('reset-btn').addEventListener('click', resetAnimation);

        function loadGraph() {
            fetch('/simulation-graph')
                .then(response => response.json())
                .then(data => {
                    const elements = [];

                    // Populate elements with nodes
                    data.graph_data.nodes.forEach(node => {
                        elements.push({
                            data: {
                                id: node.id.toString(),
                                label: node.label ? node.label : `${node.id}`,
                                profile: node.profile
                            }
                        });
                    });

                    // Populate elements with edges
                    data.graph_data.edges.forEach(edge => {
                        elements.push({
                            data: {
                                source: edge[0].toString(),
                                target: edge[1].toString()
                            }
                        });
                    });

                    // Initialize Cytoscape with the elements
                    if (cy) {
                        cy.destroy(); // Destroy the previous instance if it exists
                    }

                    cy = cytoscape({
                        container: document.getElementById('cy'),
                        elements: elements,
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'label': 'data(label)',
                                    'width': 20,
                                    'height': 20,
                                    'background-color': '#cccccc',
                                    'text-valign': 'center',
                                    'text-halign': 'center',
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 1,
                                    'line-color': '#999'
                                }
                            }
                        ],
                        layout: {
                            name: 'grid', // 'cose' or 'grid', 'circle', etc.
                            fit: true,
                            padding: 10
                        }
                    });

                    // Tooltip setup
                    const tooltip = document.createElement('div');
                    tooltip.className = 'cy-tooltip';
                    document.getElementById('cy').appendChild(tooltip);

                    cy.on('click', 'node', function(evt) {
                        const node = evt.target;
                        const nodeData = elements.find(el => el.data.id === node.id());

                        if (nodeData && nodeData.data.profile) {
                            const content = `
                                <strong>${nodeData.data.profile.Name}</strong><br>
                                Location: ${nodeData.data.profile.Location}<br>
                                Age: ${nodeData.data.profile.Age}<br>
                                Gender: ${nodeData.data.profile.Gender}<br>
                                Occupation: ${nodeData.data.profile.Occupation}<br>
                                ${nodeData.data.profile.Description}
                            `;
                            tooltip.innerHTML = content;
                            tooltip.style.display = 'block';

                            const position = node.renderedPosition();
                            tooltip.style.left = (position.x + 15) + 'px';
                            tooltip.style.top = (position.y - tooltip.offsetHeight - 15) + 'px';
                        }
                    });

                    cy.on('mouseover', 'node', function(evt) {
                        const node = evt.target;
                        const tooltipContent = updateTooltip(node.id());

                        tooltip.innerHTML = tooltipContent;
                        tooltip.style.display = 'block';

                        const position = node.renderedPosition();
                        tooltip.style.left = (position.x + 15) + 'px';
                        tooltip.style.top = (position.y - tooltip.offsetHeight - 15) + 'px';
                    });

                    cy.on('mouseout', 'node', function() {
                        tooltip.style.display = 'none';
                    });
                })
                .catch(error => console.error('Error loading graph:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSimulationData();
            loadGraph(); // Ensure the graph is loaded when the page is ready
        });

    </script>
</body>
</html>
